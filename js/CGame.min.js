function CGame(t,e){var i,r,a,n,o,s,h,f,l,c,g,_,p,u;this._init=function(t){i=!0,r=DIFFICULTY[t],0,o=0,s=0,h=s_szImageSelected;var e=createBitmap(s_oSpriteLibrary.getSprite("bg_game"));s_oStage.addChild(e);var a=createBitmap(s_oSpriteLibrary.getSprite("frame"));a.x=BOARD_X-15,a.y=BOARD_Y+25,a.scaleX=a.scaleY=.95,s_oStage.addChild(a),(u=createBitmap(s_oSpriteLibrary.getSprite(h))).x=BOARD_X+25,u.y=BOARD_Y+65,u.scaleX=u.scaleY=.87,u.alpha=.5,u.visible=!1,s_oStage.addChild(u),this._createShufflePoints(),this._attachImage(t),this._initJoints(),p=new CInterface,setTimeout((function(){s_oGame.shuffleBoard()}),2e3)},this.unload=function(){p.unload(),createjs.Tween.removeAllTweens(),s_oStage.removeAllChildren(),s_oGame=null},this.restart=function(){s=0,o=0,i=!1;for(var t=0;t<a;t++)for(var e=0;e<n;e++)f[t][e].reset(p.isRotationActive());this._initJoints(),u.alpha=.5,u.visible=p.isPreviewVisible()},this._createShufflePoints=function(){var t=new createjs.Rectangle(BOARD_X-300,BOARD_Y+100,100,BOARD_Y+500),e=new createjs.Rectangle(BOARD_X+IMAGE_WIDTH+200,BOARD_Y+100,100,BOARD_Y+500);l=new Array;for(var i=0;i<r/2;i++){var a={x:Math.floor(Math.random()*(t.x+t.width-t.x+1))+t.x,y:Math.floor(Math.random()*(t.y+t.height-t.y+1))+t.y};l.push(a);a={x:Math.floor(Math.random()*(e.x+t.width-e.x+1))+e.x,y:Math.floor(Math.random()*(e.y+t.height-e.y+1))+e.y};l.push(a)}shuffle(l)},this._attachImage=function(t){_=new createjs.Container,s_oStage.addChild(_);for(var e="of"+r,i=s_oGameSettings.getPieces(r),o=s_oGameSettings.getPieceJoints(r),s={},l=0;l<r;l++)s["frame_"+l]=l;var c={images:[s_oSpriteLibrary.getSprite(h)],frames:i,animations:s},g=new createjs.SpriteSheet(c);f=new Array;var p=s_oGameSettings.getPieceSize(r);a=p.rows,n=p.cols;for(var u=0;u<a;u++){f[u]=new Array;for(l=0;l<n;l++){var v=u*n+l,d=s_oSpriteLibrary.getSprite("piece_"+v+e),S=new CPiece(BOARD_X+i[v][0],BOARD_Y+i[v][1],d.width,d.height,LOGIC_CIRCLE_RADIUS[t],o[v],v,d,s_oSpriteLibrary.getSprite("effect_piece_"+v+e),g,_);f[u][l]=S}}this._scalePieces(.87,90,90)},this._scalePieces=function(t,e,i){for(let e=0;e<f.length;e++)for(let i=0;i<f[e].length;i++){f[e][i].getContainer().scaleX*=t,f[e][i].getContainer().scaleY*=t;for(let r in f[e][i].getLogicCircleHitArea())f[e][i].getLogicCircleHitArea()[r]&&(f[e][i].getLogicCircleHitArea()[r].pointer.scaleX*=t,f[e][i].getLogicCircleHitArea()[r].pointer.scaleY*=t)}const r=[];for(let t=0;t<f.length;t++){r.push([]);for(let e=0;e<f[t].length;e++)r[t].push({x:f[t][e].getStartingX(),y:f[t][e].getStartingY()})}const a=[];for(let e=0;e<r.length;e++){a.push([]);for(let i=0;i<r[e].length;i++)a[e].push({x:r[e][i].x*t,y:r[e][i].y*t})}for(let t=0;t<f.length;t++)for(let r=0;r<f[t].length;r++)f[t][r].getContainer().x=a[t][r].x+e,f[t][r].getContainer().y=a[t][r].y+i,f[t][r].resetStartingPosition()},this._initJoints=function(){g=new Array,c=new Array;for(var t=0;t<a;t++)for(var e=0;e<n;e++){if(e+1<n){var i=f[t][e].getJoint(JOINT_RIGHT),r=f[t][e+1].getJoint(JOINT_LEFT);c.push({joint1:i,joint2:r})}if(t+1<a){i=f[t][e].getJoint(JOINT_DOWN),r=f[t+1][e].getJoint(JOINT_UP);c.push({joint1:i,joint2:r})}}},this.shuffleBoard=function(){for(var t=0;t<a;t++)for(var e=0;e<n;e++)f[t][e].moveTo(l[t*n+e]);i=!1},this.draggingPiece=function(t,e,i,r){var a=_.numChildren-1;i.setDepth(a);for(var n=0;n<r.length;n++)if(i!==r[n]){var o={x:r[n].getStartingX()-i.getStartingX(),y:r[n].getStartingY()-i.getStartingY()};r[n].draggedByOtherPiece(t,e,o),a--,r[n].setDepth(a)}},this.releasePiece=function(t,e){!1===this._checkCollision(t,e)&&playSound("place",1,!1);for(var i=0,o=0;o<a;o++)for(var s=0;s<n;s++)f[o][s].isAttached()&&i++;i===r&&this._win()},this._checkCollision=function(t,e){for(var i=!1,r=0;r<a;r++)for(var o=0;o<n;o++)if(t!==f[r][o]&&0===t.getAbsRotation()&&0===f[r][o].getAbsRotation()){var s=f[r][o].checkCollision(e);if(null!==s){var h=s.joint1,l=s.joint2;if(this._findJointInList(h,l)){for(var c=f[r][o].getDiffX(),g=f[r][o].getDiffY(),_=t.snap(c,g),p=0;p<_.length;p++)_[p].snap(c,g);this._updateActiveJoints(t,f[r][o]),f[r][o].removeJoint(h),t.removeJoint(l),playSound("snap",1,!1),i=!0}}}return i},this._findJointInList=function(t,e){for(var i=0;i<c.length;i++)if(t===c[i].joint1&&e===c[i].joint2||t===c[i].joint2&&e===c[i].joint1)return!0;return!1},this._updateActiveJoints=function(t,e){for(var i=[t],r=!1,a=0;a<g.length;a++){for(var n=g[a],o=0;o<n.length;o++)if(n[o]===t){i=n,r=!0;break}if(r){g.splice(a,1);break}}for(var s=0;s<i.length;s++){for(r=!1,a=0;a<g.length;a++){for(n=g[a],o=0;o<n.length;o++)if(n[o]===e){g[a].push(i[s]),i[s].updateJointList(g[a]),r=!0;break}if(r)break}r||(g[g.length]=new Array,g[g.length-1].push(i[s]),g[g.length-1].push(e),i[s].updateJointList(g[g.length-1]),e.updateJointList(g[g.length-1]))}t.setAttached(!0),e.setAttached(!0)},this._win=function(){p.playWinEffect()},this.pause=function(t){i=t},this.placePiecesInCorrectPosition=function(){for(var t=0;t<a;t++)for(var e=0;e<n;e++)f[t][e].setStartingPosition()},this.playFinalEffect=function(){switch((o=Math.floor((999999-s)/100))<0&&(o=0),r){case DIFFICULTY[0]:o=parseInt(o/4);break;case DIFFICULTY[1]:o=parseInt(o/3);break;case DIFFICULTY[2]:o=parseInt(o/2)}for(var t=0;t<a;t++)for(var e=0;e<n;e++)f[t][e].fadeOut();u.visible=!0,u.alpha=0,createjs.Tween.get(u).to({alpha:1},TIME_FADE_OUT_PIECES).call((function(){new CEndPanel(s_oSpriteLibrary.getSprite("msg_box"),o).show()})),i=!0,playSound("win",1,!1)},this.showPreview=function(t){u.visible=t},this.toggleRotation=function(t){for(var e=0;e<a;e++)for(var i=0;i<n;i++)f[e][i].setRotation(t)},this.onExit=function(){this.unload(),s_oMain.gotoForm()},this.update=function(){i||(s+=s_iTimeElaps,p.refreshTime(formatTime(s)))},s_oGame=this,this._init(t)}var s_oGame;