function CGame(t,e){var i,n,r,a,o,s,h,f,l,c,g,_,u,p;this._init=function(t){i=!0,n=DIFFICULTY[t],0,o=0,s=0,h=s_szImageSelected;var e=createBitmap(s_oSpriteLibrary.getSprite("bg_game"));s_oStage.addChild(e);var r=createBitmap(s_oSpriteLibrary.getSprite("frame"));r.x=BOARD_X-15,r.y=BOARD_Y+25,r.scaleX=r.scaleY=.95,s_oStage.addChild(r),(p=createBitmap(s_oSpriteLibrary.getSprite(h))).x=BOARD_X+25,p.y=BOARD_Y+65,p.scaleX=p.scaleY=.87,p.alpha=.5,p.visible=!0,s_oStage.addChild(p),this._createShufflePoints(),this._attachImage(t),this._initJoints(),u=new CInterface,setTimeout((function(){s_oGame.shuffleBoard()}),2e3)},this.unload=function(){u.unload(),createjs.Tween.removeAllTweens(),s_oStage.removeAllChildren(),s_oGame=null},this.restart=function(){s=0,o=0,i=!1;for(var t=0;t<r;t++)for(var e=0;e<a;e++)f[t][e].reset(u.isRotationActive());this._initJoints(),p.alpha=.5,p.visible=u.isPreviewVisible()},this._createShufflePoints=function(){var t=new createjs.Rectangle(BOARD_X-300,BOARD_Y+100,100,BOARD_Y+500),e=new createjs.Rectangle(BOARD_X+IMAGE_WIDTH+200,BOARD_Y+100,100,BOARD_Y+500);l=new Array;for(var i=0;i<n/2;i++){var r={x:Math.floor(Math.random()*(t.x+t.width-t.x+1))+t.x,y:Math.floor(Math.random()*(t.y+t.height-t.y+1))+t.y};l.push(r);r={x:Math.floor(Math.random()*(e.x+t.width-e.x+1))+e.x,y:Math.floor(Math.random()*(e.y+t.height-e.y+1))+e.y};l.push(r)}shuffle(l)},this._attachImage=function(t){_=new createjs.Container,s_oStage.addChild(_);for(var e="of"+n,i=s_oGameSettings.getPieces(n),o=s_oGameSettings.getPieceJoints(n),s={},l=0;l<n;l++)s["frame_"+l]=l;var c={images:[s_oSpriteLibrary.getSprite(h)],frames:i,animations:s},g=new createjs.SpriteSheet(c);f=new Array;var u=s_oGameSettings.getPieceSize(n);r=u.rows,a=u.cols;for(var p=0;p<r;p++){f[p]=new Array;for(l=0;l<a;l++){var v=p*a+l,d=s_oSpriteLibrary.getSprite("piece_"+v+e),S=new CPiece(BOARD_X+i[v][0],BOARD_Y+i[v][1],d.width,d.height,LOGIC_CIRCLE_RADIUS[t],o[v],v,d,s_oSpriteLibrary.getSprite("effect_piece_"+v+e),g,_);f[p][l]=S}}this._scalePieces(.87,90,90)},this._scalePieces=function(t,e,i){for(let e=0;e<f.length;e++)for(let i=0;i<f[e].length;i++){f[e][i].getContainer().scaleX*=t,f[e][i].getContainer().scaleY*=t;for(let n in f[e][i].getLogicCircleHitArea())f[e][i].getLogicCircleHitArea()[n]&&(f[e][i].getLogicCircleHitArea()[n].pointer.scaleX*=t,f[e][i].getLogicCircleHitArea()[n].pointer.scaleY*=t)}const n=[];for(let t=0;t<f.length;t++){n.push([]);for(let e=0;e<f[t].length;e++)n[t].push({x:f[t][e].getStartingX(),y:f[t][e].getStartingY()})}const r=[];for(let e=0;e<n.length;e++){r.push([]);for(let i=0;i<n[e].length;i++)r[e].push({x:n[e][i].x*t,y:n[e][i].y*t})}for(let t=0;t<f.length;t++)for(let n=0;n<f[t].length;n++)f[t][n].getContainer().x=r[t][n].x+e,f[t][n].getContainer().y=r[t][n].y+i,f[t][n].resetStartingPosition()},this._initJoints=function(){g=new Array,c=new Array;for(var t=0;t<r;t++)for(var e=0;e<a;e++){if(e+1<a){var i=f[t][e].getJoint(JOINT_RIGHT),n=f[t][e+1].getJoint(JOINT_LEFT);c.push({joint1:i,joint2:n})}if(t+1<r){i=f[t][e].getJoint(JOINT_DOWN),n=f[t+1][e].getJoint(JOINT_UP);c.push({joint1:i,joint2:n})}}},this.shuffleBoard=function(){for(var t=0;t<r;t++)for(var e=0;e<a;e++)f[t][e].moveTo(l[t*a+e]);i=!1},this.draggingPiece=function(t,e,i,n){var r=_.numChildren-1;i.setDepth(r);for(var a=0;a<n.length;a++)if(i!==n[a]){var o={x:n[a].getStartingX()-i.getStartingX(),y:n[a].getStartingY()-i.getStartingY()};n[a].draggedByOtherPiece(t,e,o),r--,n[a].setDepth(r)}},this.releasePiece=function(t,e){!1===this._checkCollision(t,e)&&playSound("place",1,!1);for(var i=0,o=0;o<r;o++)for(var s=0;s<a;s++)f[o][s].isAttached()&&i++;i===n&&this._win()},this._checkCollision=function(t,e){for(var i=!1,n=0;n<r;n++)for(var o=0;o<a;o++)if(t!==f[n][o]&&0===t.getAbsRotation()&&0===f[n][o].getAbsRotation()){var s=f[n][o].checkCollision(e);if(null!==s){var h=s.joint1,l=s.joint2;if(this._findJointInList(h,l)){for(var c=f[n][o].getDiffX(),g=f[n][o].getDiffY(),_=t.snap(c,g),u=0;u<_.length;u++)_[u].snap(c,g);this._updateActiveJoints(t,f[n][o]),f[n][o].removeJoint(h),t.removeJoint(l),playSound("snap",1,!1),i=!0}}}return i},this._findJointInList=function(t,e){for(var i=0;i<c.length;i++)if(t===c[i].joint1&&e===c[i].joint2||t===c[i].joint2&&e===c[i].joint1)return!0;return!1},this._updateActiveJoints=function(t,e){for(var i=[t],n=!1,r=0;r<g.length;r++){for(var a=g[r],o=0;o<a.length;o++)if(a[o]===t){i=a,n=!0;break}if(n){g.splice(r,1);break}}for(var s=0;s<i.length;s++){for(n=!1,r=0;r<g.length;r++){for(a=g[r],o=0;o<a.length;o++)if(a[o]===e){g[r].push(i[s]),i[s].updateJointList(g[r]),n=!0;break}if(n)break}n||(g[g.length]=new Array,g[g.length-1].push(i[s]),g[g.length-1].push(e),i[s].updateJointList(g[g.length-1]),e.updateJointList(g[g.length-1]))}t.setAttached(!0),e.setAttached(!0)},this._win=function(){u.playWinEffect()},this.pause=function(t){i=t},this.placePiecesInCorrectPosition=function(){for(var t=0;t<r;t++)for(var e=0;e<a;e++)f[t][e].setStartingPosition()},this.playFinalEffect=function(){switch((o=Math.floor((999999-s)/100))<0&&(o=0),n){case DIFFICULTY[0]:o=parseInt(o/4);break;case DIFFICULTY[1]:o=parseInt(o/3);break;case DIFFICULTY[2]:o=parseInt(o/2)}for(var t=0;t<r;t++)for(var e=0;e<a;e++)f[t][e].fadeOut();p.visible=!0,p.alpha=0,createjs.Tween.get(p).to({alpha:1},TIME_FADE_OUT_PIECES).call((function(){new CEndPanel(s_oSpriteLibrary.getSprite("msg_box"),o).show()})),i=!0,playSound("win",1,!1)},this.showPreview=function(t){p.visible=t},this.toggleRotation=function(t){for(var e=0;e<r;e++)for(var i=0;i<a;i++)f[e][i].setRotation(t)},this.onExit=function(){this.unload(),s_oMain.gotoForm(o)},this.onExitToMenu=function(){this.unload(),s_oMain.gotoMenu()},this.update=function(){i||(s+=s_iTimeElaps,u.refreshTime(formatTime(s)))},s_oGame=this,this._init(t)}var s_oGame;